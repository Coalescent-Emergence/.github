# Architecture Guardian Agent

## Purpose
Check pull requests against organizational and repository-level ADRs to identify potential architectural violations. Provides advisory feedback, not blocking enforcement.

## Role
Architecture reviewer referencing documented decisions to maintain consistency and catch drift early.

## Trigger
- **Automatic**: Runs on all PRs via [GitHub Actions workflow](../../workflows/agent-architecture-guardian.yml)
- **Manual**: Can be invoked by `ai:review` label on PRs

## Inputs
- **PR diff**: Modified files and changes
- **PR description**: Context from developer
- **ADRs**: Both org-level (`.github/docs/decisions/`) and repo-level (`{repo}/docs/decisions/`)
- **Target repository**: Which repo the PR targets

## Outputs
PR comment with:
- **violations**: Array of potential ADR conflicts with:
  - `adr_id`: Which ADR is potentially violated
  - `severity`: advisory, warning, critical
  - `description`: What the concern is
  - `suggestion`: Small corrective change
  - `line_numbers`: Specific file:line references
- **compliant_decisions**: ADRs that PR correctly follows
- **missing_adr**: Situations where a new ADR might be needed
- **confidence**: 0-100 score

## Advisory vs Blocking

**Advisory** (informational):
- Suggests better approach per existing ADR
- Pattern variation that may or may not be intentional
- Style/convention deviations

**Warning** (review carefully):
- Direct contradiction of ADR decision
- Using deprecated pattern per ADR
- Missing required component per ADR

**Critical** (likely needs changes):
- Security violation per compliance ADR
- Breaking change to cross-repo contract
- Bypassing architecture guardrails

**Not blocking**: All severities are advisory. Human reviewer makes final decision.

## Usage Example

### Input
PR in Kerrigan repository modifying `internal/auth/jwt.go` to use RS256 instead of HS256.

Relevant ADR: `Kerrigan/docs/decisions/0004-jwt-signing-algorithm.md` specifies HS256 for MVP simplicity.

### Output (Posted as PR Comment)
```markdown
### üèõÔ∏è Architecture Guardian Review

**Status**: ‚ö†Ô∏è Potential ADR violations detected

#### Violations

##### ‚ö†Ô∏è Warning: JWT Signing Algorithm Change
- **ADR**: [0004-jwt-signing-algorithm.md](../Kerrigan/docs/decisions/0004-jwt-signing-algorithm.md)
- **Decision**: Use HS256 for MVP (symmetric key, simpler key management)
- **PR Change**: Switching to RS256 (asymmetric, requires public/private keypair)
- **Line**: [internal/auth/jwt.go:45](../internal/auth/jwt.go#L45)
- **Suggestion**: If RS256 is needed for token verification by external services, consider updating ADR 0004 to document the decision change and rationale. Otherwise, revert to HS256 per MVP scope.
- **Confidence**: 85%

#### Compliant Decisions

‚úÖ **ADR 0001**: Repository structure - Changes in `internal/auth/` follow established package layout

‚úÖ **ADR 0002**: Go as backend language - Using Go standard patterns

#### Recommendations

**Missing ADR**: If RS256 adoption is intentional (e.g., requirement for token sharing with UI or services), recommend creating ADR documenting:
- Why RS256 needed vs HS256
- Key management strategy (rotation, storage)  
- Migration path for existing HS256 tokens

**Overall Confidence**: 78% - Clear algorithm change detected, but context in PR description may justify it. Human review recommended.

---
*Advisory only - human reviewer makes final decision. Generated by Architecture Guardian agent.*
```

## Cross-Repository ADR Checking

When checking PRs, agent loads ADRs from:
1. **Org-level**: `.github/docs/decisions/*.md` (cross-cutting decisions)
2. **Repo-level**: `{repo}/docs/decisions/*.md` (repo-specific decisions)

Org-level ADRs apply to all repos. Example:
- PR in UI repository checked against `.github/docs/decisions/0003-layered-service-architecture.md` (org-wide) and `UI/docs/decisions/*.md` (UI-specific)

## Integration
- Auto-runs via [workflow](../../workflows/agent-architecture-guardian.yml) on PR creation/update
- Parses MADR-style ADRs using [ADR template](../../docs/decisions/template.md)
- Posts results as PR review comment
- Links to specific files and line numbers in violations
- Can be suppressed with `adr-exempt` label (requires justification)

## Files
- [prompt.md](./prompt.md) - System prompt and ADR analysis templates
- [schema.json](./schema.json) - JSON schema for violation outputs
- [examples/](./examples/) - Sample PR reviews with violations
