name: AI Agent - Architecture Guardian
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  guard-architecture:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out .github repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/.github
          path: .github-repo
          
      - name: Check out PR branch
        uses: actions/checkout@v4
        with:
          path: pr-repo
          ref: ${{ github.event.pull_request.head.sha }}
          
      - name: Find all ADRs
        id: find-adrs
        run: |
          echo "Searching for ADRs in org-level and repo-level..."
          
          # Org-level ADRs
          ORG_ADRS=""
          if [ -d ".github-repo/docs/decisions" ]; then
            ORG_ADRS=$(find .github-repo/docs/decisions -name "*.md" -not -name "README.md" -not -name "template.md")
          fi
          
          # Repo-level ADRs
          REPO_ADRS=""
          if [ -d "pr-repo/docs/decisions" ]; then
            REPO_ADRS=$(find pr-repo/docs/decisions -name "*.md" -not -name "README.md" -not -name "template.md")
          fi
          
          echo "org_adrs=$ORG_ADRS" >> $GITHUB_OUTPUT
          echo "repo_adrs=$REPO_ADRS" >> $GITHUB_OUTPUT
          
      - name: Get PR diff
        id: diff
        run: |
          cd pr-repo
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.sha }} > ../pr-diff.txt
          
      - name: Analyze PR against ADRs
        id: analyze
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Placeholder - actual implementation would:
          # 1. Load all ADRs (org + repo level)
          # 2. Analyze PR diff
          # 3. Call OpenAI API with Architecture Guardian prompt
          # 4. Detect violations
          
          echo "AI agent would check PR diff against ADRs"
          
          # Mock output
          cat > analysis.json << 'EOF'
          {
            "violations": [],
            "compliant_decisions": ["ADR-0001", "ADR-0002"],
            "missing_adr": [],
            "confidence": 92
          }
          EOF
          
      - name: Post architecture review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = JSON.parse(fs.readFileSync('analysis.json', 'utf8'));
            
            let comment = `### ğŸ›ï¸ Architecture Guardian Review\n\n`;
            
            if (analysis.violations.length === 0) {
              comment += `**Status**: âœ… No ADR violations detected\n\n`;
            } else {
              comment += `**Status**: âš ï¸ Potential ADR violations found\n\n`;
              comment += `#### Violations\n\n`;
              analysis.violations.forEach(v => {
                const icon = v.severity === 'critical' ? 'ğŸ”´' : v.severity === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
                comment += `${icon} **${v.severity}**: ${v.description}\n`;
                comment += `- **ADR**: ${v.adr_id}\n`;
                if (v.suggestion) comment += `- **Suggestion**: ${v.suggestion}\n`;
                comment += `\n`;
              });
            }
            
            if (analysis.compliant_decisions.length > 0) {
              comment += `#### Compliant with ADRs\n\n`;
              analysis.compliant_decisions.forEach(adr => {
                comment += `âœ… ${adr}\n`;
              });
              comment += `\n`;
            }
            
            if (analysis.missing_adr.length > 0) {
              comment += `#### Recommendations\n\n`;
              analysis.missing_adr.forEach(rec => {
                comment += `ğŸ“ ${rec}\n`;
              });
              comment += `\n`;
            }
            
            comment += `**Confidence**: ${analysis.confidence}%\n\n`;
            comment += `---\n*Advisory only - human review required. Generated by Architecture Guardian agent.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
